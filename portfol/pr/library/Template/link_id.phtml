<?$id = 'homeForm'.Mikron_Crud::getNextId()?>
<?$_input_id = 'field_'.Mikron_Crud::getNextId()?>
<?$real_field_name = $field->name;
$class_name = $field->link;
// echo '<pre>', print_r($field, 1), '</pre>';
$filter = array();
if(property_exists($field, 'filter') && $field->filter) {
    $filter = $field->filter;
}
$list = Mikron_Entity_Model::getList($class_name, $filter, null, null, null);
$to_string_field = $class_name::getToStringFormat();
?>

<?$value = Mikron_Entity_Model::getRowValueByPath($item, $field)?>
<?$cur_val = $item->$real_field_name;?>

<?if($field->readonly){?>
	<?=$value;return;?>
<?}?>

<select name="form[<?=$field->name?>]" <?= !$field->readonly ?: 'disabled="disabled"'; ?>>
    <option value="">Выберите из списка...</option>
    <?foreach($list->items as $row) {?>
        <?$option_id = $row['id']?>
        <?if(is_callable($field->format)) {
            $option_value = call_user_func($field->format, $row);
        } else {
            $option_value = $row[$to_string_field];
        }?>
        <?/*if($field->path) {
            $p = explode('/', $field->path);
            $pc = count($p);
            if($pc > 1) {
                // $p = array_slice($p, count($p) - 2, 2);
                // array_shift($p);
                foreach($p as $_pc_index => $k) {
                   // $row = $row->$k;
                   // if($_pc_index >= $pc - 2) {
                   //     break;
                   // }
                }
               $option_value = $row[array_pop($p)];
            }
        }*/?>
        <option <?if($cur_val == $option_id){?>selected="selected"<?}?> value="<?=$option_id?>"><?=$option_value?></option>
    <?}?>
</select>
