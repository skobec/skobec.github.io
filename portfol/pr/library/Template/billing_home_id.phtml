<!--шаблон выбора домов с учетом нахождения дома в РО, либо в спец.-->
<?$id = 'homeForm'.Mikron_Crud::getNextId()?>
<?$_input_id = 'field_'.Mikron_Crud::getNextId()?>
<?$real_field_name = $field->name;?>
<?$editor_setting = (array)$field->editor_setting; ?>
<?$home_composite_setting = (array_key_exists('include_home_composite', $editor_setting) && $editor_setting['include_home_composite'] != '') ? ($editor_setting['include_home_composite'] ? 1:0) : 0;?>
<?$value = Mikron_Entity_Model::getRowValueByPath($item, $field)?>
<span style="display: block; padding: 0; margin-bottom: 4px;"><?= $value ? $value : 'Дом не выбран'; ?></span>

<?if(!$field->readonly) {?>
    <a class="btn btn-default" onclick="$('#<?=$id?>').toggle(); CustomUI.centerForms(); return false;">выбрать...</a>
<?}?>

<input type="hidden" name="form[<?=$field->name?>]" value="<?=$item->$real_field_name?>" id="<?=$_input_id?>" />

<?
    $next_id = Mikron_Crud::getNextId();
    $district_id = 'loc_f'.Mikron_Crud::getNextId();
    $loc_id = 'loc_f'.Mikron_Crud::getNextId();
    $street_id = 'street_f'.Mikron_Crud::getNextId();
    $house_id = 'house_f'.Mikron_Crud::getNextId();
    $form_id = 'form_f'.Mikron_Crud::getNextId();
    $search_home_btn = 'search_home_btn_f'.Mikron_Crud::getNextId();
	$billing_bill_type_id = array_key_exists('billing_bill_type_id', $editor_setting) && $editor_setting['billing_bill_type_id'] ?  $editor_setting['billing_bill_type_id'] : null;
	$region_district_list = (array_key_exists('loc_id', $editor_setting) && $editor_setting['loc_id'] != '') ? array(Service::Address()->getRegionById($editor_setting['loc_id'])) : Service::Address()->getRegionDistrictList(null, 'title_with_prefix');
?>

<div style="display: none; padding: 1em 0;" id="<?=$id?>">

<script>
/*
    var district        = null,
        locality            = null,
        street              = null,
        house               = null,
        cur_district_key    = null;
*/
    function searchHome<?= $next_id; ?>(a) {
        $(a).is(':disabled')
        var dis = $(a).attr('disabled');
        if(dis != 'disabled') {
            var house_id = $('#<?=$house_id?>').val();
            var house_address = $('#<?=$house_id?> option:selected').attr('address');
            $('#<?=$_input_id?>').val(house_id);
            $('#<?=$id?>').siblings('span').text(house_address);
            $('#<?=$id?>').hide();
        }
        return false;
    }

    function changeDistrict<?= $next_id; ?>(d, callback) {
        var key = $(d).children('option:selected').val();
        district = $('#<?=$district_id?>').val();
        localityUpdate<?= $next_id; ?>(district);
        if(callback) {
            callback();   
        }
    }

    function changeLocality<?= $next_id; ?>(callback) {
        locality = $('#<?=$loc_id?>').val();
        // clearListHouse();
        if(locality) {
            streetUpdate<?= $next_id; ?>(locality);
        }
        if(callback) {
            callback();
        }
    }

    function changeStreet<?= $next_id; ?>(callback) {
        street = $('#<?=$street_id?>').val();
        if(street) {
            houseUpdate<?= $next_id; ?>(street);   
        }else{
            lcode = $('#<?=$loc_id?>').val();
            houseUpdate<?= $next_id; ?>(lcode, '0');
        }
        if(callback) {
            callback();
        }
    }

	function loadHomeCompositeItems(home_id, cursor){
		var img_delay = "<img src ='../../../../../img/fancybox_loading.gif' style='padding-left: 20px;' id='actual_address_loading_gif'>";
		$(cursor).closest('table tr').after('<tr><th>Фактический адрес</th><td id="actual_address_container">' + img_delay + '</td></tr>');
		$.ajax({
			type: 'get',
			url: '/autocomplete/gethomecomposite/id/' + home_id +'/',
			success: function(data) {
				if(data.length == 0) {
					return false;
				}
				else {
					html = '<select name="form[home_composite_id]" id="home_composite_select">';
					html += '<option value>Выберите дом...</option>';
					for(var i = 0; i < data.length; i++) {
						html += '<option value="' + data[i].id + '" address="' + data[i].address + '" home_composite_id="' + data[i].home_composite_id + '">' + data[i].title + '</option>';
					}
					html += '</select>';
					$('actual_address_loading_gif').hide();
					$('#actual_address_container').html(html).find('select').styler();
					$("#actual_address_container").delegate("select#home_composite_select", "change", function() {
						searchHomeComposite(this);
					});
				}
			}
		});
	}

	function searchHomeComposite(a) {
        $(a).is(':disabled')
        var dis = $(a).attr('disabled');
        if(dis != 'disabled') {
            var house_address = $(a).children('option:selected').attr('address');            
            $('#<?=$id?>').siblings('span').text(house_address);
            $('#<?=$id?>').hide();
        }
        return false;
    }

    $(function() {
        
        $("#<?=$loc_id?>").on('change', function() {
            changeLocality<?= $next_id; ?>(false);
        });
        
        $("#<?=$street_id?>").on('change', function() {
            changeStreet<?= $next_id; ?>(false);
        });

        $('#<?=$district_id?>').on('change', function() {
            changeDistrict<?= $next_id; ?>(this, false);
        });

        $('#<?=$house_id?>').on('change', function() {
			var home_composite_id = $(this).children('option:selected').attr('home_composite_id');
			if (home_composite_id != '' && typeof home_composite_id != 'undefined') {
				var home_id = $(this).children('option:selected').val();
				$('#<?=$_input_id?>').val(home_id);
				<?= $home_composite_setting ? 'loadHomeCompositeItems(home_id, $(this))' : ''; ?>
			} else {
				$('#actual_address_container').closest('tr').hide();
				return searchHome<?= $next_id; ?>(this);
			}
        });

        $('#<?=$district_id?> option').removeAttr('selected')
        $('#<?=$district_id?> option:first').attr('selected', 'selected');
        $('#<?=$district_id?>').trigger('refresh');

        $('#form-findHouse').data('success', function(data) {
            var home_list = data.home_list,
                home_count = home_list.length,
                id = 'searchHomeResult';
            if (data.by_locality){
                id = 'searchHomeByLocalityResult'
            }
            if ((data.by_locality && home_count > 0) || !data.by_locality){
                if($('#'+id+'Body').css('display') == 'none') {
                    $('#'+id+'Body').show();
                }
            }
            $('#'+id).html('');
            for(var i = 0; i < home_count; i++) {
                $('#tmpl-'+id).tmpl({address: home_list[i].address_string, id: home_list[i].id}).appendTo('#'+id);
            }
            hide_form();
            return false;
        });
    });

    function localityUpdate<?= $next_id; ?>(district) {
        if(district) {
            $.ajax({
                  type: 'get',
                  url: '/autocomplete/locality/district/' + district + '/',
                  success: function(data) {
                    $('#<?=$loc_id?>').html('<option value="">Выберите населенный пункт...</option>');
                    for(var i = 0; i < data.length; i++) {
                        $('#tmpl-option').tmpl({value: data[i].id, title: data[i].title}).appendTo('#<?=$loc_id?>');
                    }
                    $('#<?=$loc_id?>').attr('disabled', false).trigger('refresh');
                    if($('#<?=$loc_id?> option').length == 2) {
                        $("#<?=$loc_id?> option:gt(0)").prop('selected', true).trigger('refresh').change();
                    }
                  }
            });
        }else{
            $('#<?=$loc_id?>').html('<option value="">Выберите населенный пункт...</option>');
            $('#<?=$loc_id?>').attr('disabled', false).trigger('refresh');
        }
        $('#<?=$house_id?>').html('<option>Выберите номер дома...</option>').attr('disabled', true).trigger('refresh');
        $('#<?=$street_id?>').html('<option>Выберите улицу...</option>').attr('disabled', true).trigger('refresh');
        $('#<?=$search_home_btn?>').attr('disabled', true);
        clearListHouse<?= $next_id; ?>();
    }

    function streetUpdate<?= $next_id; ?>(lcode) {
        $.ajax({
              type: 'get',
              url: '/autocomplete/street/lcode/' + lcode + '/',
              success: function(data) {
                  // console.log(data);
                  $('#<?=$street_id?>').html('<option value="">Выберите улицу...</option>');
                  for(var i = 0; i < data.length; i++) {
                    $('#tmpl-option').tmpl({value: data[i].id, title: data[i].title}).appendTo('#<?=$street_id?>');
                  }
                  if (data.length>0){
                    $('#<?=$street_id?>').attr('disabled', false).trigger('refresh');
                  }else{
                    $('#<?=$street_id?>').attr('disabled', true).trigger('refresh').trigger('change');  
                  }
                houseUpdate<?= $next_id; ?>(lcode, '0');
              }
        });
        $('#<?=$house_id?>').html('<option>Выберите номер дома...</option>').attr('disabled', true).trigger('refresh');
        $('#<?=$search_home_btn?>').attr('disabled', true);
        // $('#searchHome-btn').attr('disabled', false);
        // searchHome($('#searchHome-btn'));
        // $('#searchHome-btn').attr('disabled', true);
        return false;
    }

    function houseUpdate<?= $next_id; ?>(scode, by_street) {
        by_street = by_street || '1';
        post_str = '';
        if (by_street=='1'){
            post_str = 'scode/'+scode;
        }else{
            post_str = 'lcode/'+scode;
        }
		<? if($billing_bill_type_id) {?>
			post_str += '/type/' + <?= $billing_bill_type_id ?>;
		<? } ?>
        $.ajax({
              type: 'get',
              url: '/autocomplete/billinghouse/' + post_str,
              success: function(data) {
                  $('#<?=$house_id?>').html('<option value="">Выберите номер дома...</option>');
                  for(var i = 0; i < data.length; i++) {
                    $('#tmpl-option').tmpl({value: data[i].id, title: data[i].title, address: data[i].address, home_composite_id: data[i].home_composite_id}).appendTo('#<?=$house_id?>');
                  }
                  if (data.length>0){
                    $('#<?=$house_id?>').attr('disabled', false).trigger('refresh');
                    $('#<?=$search_home_btn?>').attr('disabled', false);
                  }else{
                    $('#<?=$house_id?>').attr('disabled', true).trigger('refresh').trigger('change');
                    $('#<?=$search_home_btn?>').attr('disabled', true).trigger('refresh').trigger('change');
                  }
              }
        });
        return false;
    }
    
    function clearListHouse<?= $next_id; ?>(){
        $('#<?=$street_id?>').val('');
        $('#searchHomeResultBody').hide();
        $('#searchHomeByLocalityResultBody').hide();
        $('#searchHomeResult').html('');
        $('#searchHomeByLocalityResult').html('');
    }

</script>

<script type="text/x-jquery-tmpl" id="tmpl-option">
    <option value="${value}" address="${address}" home_composite_id="${home_composite_id}">${title}</option>
</script>

<style>
    .drfgh {
        background: #f5f5f5;
        border: 10px solid #f5f5f5;
    }
    .drfgh td {
        padding-bottom: 4px;
    }
    .drfgh th {
        font-size: 8pt;
        font-weight: normal;
        padding-right: 1em;
        text-align: right;
    }
</style>
    <table class="drfgh">
        <tr>
            <th><?= Constant::VAR_TEXT_RAION; ?>:</th>
            <td>
                <select name="form[district_id]" id="<?=$district_id?>" form="<?=$form_id?>">
                    <option value="">Выберите район...</option>
                    <?foreach($region_district_list as $district) {?>
                        <option value="<?=$district->id?>"><?=$district->title_with_prefix?></option>
                    <?}?>
                </select>
            </td>
        </tr>
        <tr>
            <th>Населенный пункт:</th>
            <td>
                <select name="form[locality_code]" id="<?=$loc_id?>" disabled form="<?=$form_id?>">
                    <option value="">Выберите населенный пункт...</option>
                </select>
            </td>
        </tr>
        <tr>
            <th>Улица:</th>
            <td>
                <select name="form[street_code]" id="<?=$street_id?>" disabled form="<?=$form_id?>">
                    <option value="">Выберите улицу...</option>
                </select>
            </td>
        </tr>
        <tr>
            <th>Номер дома:</th>
            <td>
                <select name="form[house_id]" id="<?=$house_id?>" disabled form="<?=$form_id?>">
                    <option value="">Выберите номер дома...</option>
                </select>
            </td>
        </tr>
        <tr>
            <th></th>
            <td><a type="submit" id="<?=$search_home_btn?>" class="btn btn-primary" disabled onclick="return searchHome<?= $next_id; ?>(this);">Выбрать</a></td>
        </tr>
    </table>

    <div id="searchHomeResultBody" style="display: none;">
        <h4>Дома выбранной улицы:</h4>
        <div id="searchHomeResult">
        </div>
    </div>

    <div id="searchHomeByLocalityResultBody" style="display: none;">
        <h4>Дома населенного пункта:</h4>
        <div id="searchHomeByLocalityResult">
        </div>
    </div>

</div>