<?$_input_id = 'field_'.Mikron_Crud::getNextId();
$prefixAction='';
if(isset($field->prefixAction)){
	$prefixAction=$field->prefixAction;
}
?>
<?$real_field_name = $field->name;?>

<?
    $next_id = Mikron_Crud::getNextId();
    $district_id = 'loc_f'.Mikron_Crud::getNextId();
    $loc_id = 'loc_f'.Mikron_Crud::getNextId();
    $street_id = 'street_f'.Mikron_Crud::getNextId();
    $house_id = 'house_f'.Mikron_Crud::getNextId();
    $form_id = property_exists($field, 'form') ? $field->form : 'form_f'.Mikron_Crud::getNextId();
    
    $region_district_list = Service::Address()->getRegionDistrictList(null, 'title_with_prefix');
?>

<div style="padding: 1em 0;">

<script>
/*
    var district        = null,
        locality            = null,
        street              = null,
        house               = null,
        cur_district_key    = null;
*/

    function changeDistrict<?= $next_id; ?>(d, callback) {
        var key = $(d).children('option:selected').val();
        district = $('#<?=$district_id?>').val();
        localityUpdate<?= $next_id; ?>(district);
        if(callback) {
            callback();   
        }
    }

    function changeLocality<?= $next_id; ?>(callback) {
        locality = $('#<?=$loc_id?>').val();
        if(locality) {
            streetUpdate<?= $next_id; ?>(locality);
        }
        if(callback) {
            callback();
        }
    }

    function changeStreet<?= $next_id; ?>(callback) {  
        street = $('#<?=$street_id?>').val();
        if(street) {
            houseUpdate<?= $next_id; ?>(street);   
        }
        else{
            var loc= $('#<?=$loc_id?>').val();
            houseUpdate<?= $next_id; ?>(loc,true); 
        }     
        if(callback) {
            callback();
        }
    }

    $(function() {
        
        $("#<?=$loc_id?>").on('change', function() {
            changeLocality<?= $next_id; ?>(false);
        });
        
        $("#<?=$street_id?>").on('change', function() {
            changeStreet<?= $next_id; ?>(false);
        });

        $('#<?=$district_id?>').on('change', function() {
            changeDistrict<?= $next_id; ?>(this, false);
        });

        $('#<?=$district_id?> option').removeAttr('selected')
        $('#<?=$district_id?> option:first').attr('selected', 'selected');
        $('#<?=$district_id?>').trigger('refresh');
        
        $('#form-findHouse').data('success', function(data) {
            var home_list = data.home_list,
                home_count = home_list.length,
                id = 'searchHomeResult';
            if (data.by_locality){
                id = 'searchHomeByLocalityResult'
            }
            if ((data.by_locality && home_count > 0) || !data.by_locality){
                if($('#'+id+'Body').css('display') == 'none') {
                    $('#'+id+'Body').show();
                }
            }
            $('#'+id).html('');
            for(var i = 0; i < home_count; i++) {
                $('#tmpl-'+id).tmpl({address: home_list[i].address_string, id: home_list[i].id}).appendTo('#'+id);
            }
            hide_form();
            return false;
        });
    })

    function localityUpdate<?= $next_id; ?>(district) {
        if(district) {
            $.ajax({
                  type: 'get',
                  url: '/autocomplete/<?=$prefixAction?>locality/district/' + district + '/',
                  success: function(data) {
                    $('#<?=$loc_id?>').html('<option value="">Выберите населенный пункт...</option>');
                    for(var i = 0; i < data.length; i++) {
                        $('#tmpl-option').tmpl({value: data[i].id, title: data[i].title}).appendTo('#<?=$loc_id?>');
                    }
                    $('#<?=$loc_id?>').attr('disabled', false).trigger('refresh');
                    if($('#<?=$loc_id?> option').length == 2) {
                        $("#<?=$loc_id?> option:gt(0)").prop('selected', true).trigger('refresh').change();
                    }
                  }
            });
        }else{
            $('#<?=$loc_id?>').html('<option value="">Выберите населенный пункт...</option>');
            $('#<?=$loc_id?>').attr('disabled', false).trigger('refresh');
        }
        $('#<?=$house_id?>').html('<option>Выберите номер дома...</option>').attr('disabled', true).trigger('refresh');
        $('#<?=$street_id?>').html('<option>Выберите улицу...</option>').attr('disabled', true).trigger('refresh');
    }

    function streetUpdate<?= $next_id; ?>(lcode) {
        $.ajax({
              type: 'get',
              url: '/autocomplete/<?=$prefixAction?>street/lcode/' + lcode + '/',
              success: function(data) {
                  // console.log(data);
                  $('#<?=$street_id?>').html('<option value="">Выберите улицу...</option>');
                  for(var i = 0; i < data.length; i++) {
                    $('#tmpl-option').tmpl({value: data[i].id, title: data[i].title}).appendTo('#<?=$street_id?>');
                  }
                  if (data.length>0){
                    $('#<?=$street_id?>').attr('disabled', false).trigger('refresh');
                  }else{
                    $('#<?=$street_id?>').attr('disabled', true).trigger('refresh').trigger('change');  
                  }
              }
        });
        $('#<?=$house_id?>').html('<option>Выберите номер дома...</option>').attr('disabled', true).trigger('refresh');
        return false;
    }

    function houseUpdate<?= $next_id; ?>(scode, by_street) {                                                
        post_str = '';
        if (by_street===undefined){
            post_str = 'scode/'+scode;
        }else{
            post_str = 'lcode/'+scode;
        }
        $.ajax({
              type: 'get',
              url: '/autocomplete/<?=$prefixAction?>house/' + post_str + '/',
              success: function(data) {
                  $('#<?=$house_id?>').html('<option value="">Выберите номер дома...</option>');
                  for(var i = 0; i < data.length; i++) {
                    $('#tmpl-option').tmpl({value: data[i].id, title: data[i].title, address: data[i].address, home_composite_id: data[i].home_composite_id}).appendTo('#<?=$house_id?>');
                  }
                  $('#<?=$house_id?>').attr('disabled', false).trigger('refresh');
              }
        });
        return false;
    }

</script>

<script type="text/x-jquery-tmpl" id="tmpl-option">
    <option value="${value}" address="${address}" home_composite_id="${home_composite_id}">${title}</option>
</script>

<style type="">
    .drfgh {
        background: #f5f5f5;
        border: 10px solid #f5f5f5;
    }
    .drfgh th {
        font-size: 8pt;
        font-weight: normal;
        padding-right: 1em;
        text-align: right;
    }
</style>

    <table class="drfgh">
        <tr>
            <th><?= Constant::VAR_TEXT_RAION; ?>:</th>
            <td>
                <select name="form[district_id]" id="<?=$district_id?>" form="<?=$form_id?>">
                    <option value="">Выберите район...</option>
                    <?foreach($region_district_list as $district) {?>
                        <option value="<?=$district->id?>"><?=$district->title_with_prefix?></option>
                    <?}?>
                </select>
            </td>
        </tr>
        <tr>
            <th>Населенный пункт:</th>
            <td>
                <select name="form[locality_code]" id="<?=$loc_id?>" disabled form="<?=$form_id?>">
                    <option value="">Выберите населенный пункт...</option>
                </select>
            </td>
        </tr>
        <?php if(!isset($disableStreet) || $disableStreet === false):?>
        <tr>
            <th>Улица:</th>
            <td>
                <select name="form[street_code]" id="<?=$street_id?>" disabled form="<?=$form_id?>">
                    <option value="">Выберите улицу...</option>
                </select>
            </td>
        </tr>
        <?endif;?>
        <?php if(!isset($disableHouse) || $disableHouse === false):?>
        <tr>
            <th>Номер дома:</th>
            <td>
                <select name="form[house_id]" id="<?=$house_id?>" disabled form="<?=$form_id?>">
                    <option value="">Выберите номер дома...</option>
                </select>
            </td>
        </tr>
        <?endif;?>
    </table>

</div>